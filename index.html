<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sentient Artist Challenge</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#0b0c10; --card:#111317; --muted:#9196a1; --text:#e9edf3;
      --primary:#5865f2; --primary-600:#4752e0; --ok:#22c55e; --danger:#ef4444;
      --chip:#1f232b;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui,Arial,sans-serif;
      background:linear-gradient(180deg,#0a0b0e 0%, #0f1117 100%);
      color:var(--text);
    }
    .container{max-width:1060px;margin:24px auto;padding:0 16px}
    h1{margin:0 0 8px;font-size:34px;font-weight:800;letter-spacing:.2px;text-align:center}
    .sub{color:var(--muted);text-align:center;margin-bottom:10px}
    .timer{color:#b3c8ff;text-align:center;margin-bottom:20px;font-weight:600}
    .bar{display:flex;gap:8px;justify-content:center;align-items:center;flex-wrap:wrap;margin:24px 0}
    input,button{height:38px;border-radius:8px;border:1px solid #2a2f3a;background:#0f1220;color:var(--text)}
    input{padding:0 12px;min-width:220px}
    button{padding:0 14px;cursor:pointer;background:var(--primary);border:none}
    button:hover{background:var(--primary-600)}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:20px}
    @media (max-width:980px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:640px){.grid{grid-template-columns:1fr}}
    .card{
      background:var(--card);border:1px solid #1b1f2a;border-radius:16px;overflow:hidden;
      box-shadow:0 10px 24px rgba(0,0,0,.4);display:flex;flex-direction:column
    }
    .imgbox{width:100%;height:300px;overflow:hidden;background:#0c0f16;display:flex;align-items:center;justify-content:center}
    .imgbox img{width:100%;height:100%;object-fit:cover;display:block}
    .content{padding:14px 16px 16px}
    .user{font-weight:700;margin:0 0 6px;letter-spacing:.2px}
    .muted{color:var(--muted);font-size:14px}
    .row{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-top:8px}
    .voteBtn{background:var(--primary);padding:8px 12px;border-radius:8px;border:none;color:#fff;font-weight:600}
    .voteBtn[disabled]{background:#2e3445}
    .chip{background:var(--chip);border:1px solid #242938;border-radius:999px;padding:6px 10px;color:#cbd5e1;font-weight:600;font-size:13px}
    .ok{color:#00e091}
    .err{color:#ff7b7b}
    .tiny{font-size:13px;color:var(--muted)}
    .hide{display:none}
  </style>
</head>
<body>
  <div class="container">
    <h1>Sentient Artist Challenge</h1>
    <div class="sub">Hafta: <span id="roundLabel">loading…</span></div>
    <div class="timer">Kalan süre: <span id="countdown">–</span></div>

    <!-- Yalnızca topluluk için: kullanıcı adı + dosya yükleme -->
    <div class="bar">
      <input id="username" type="text" placeholder="Kullanıcı adınız" />
      <input id="file" type="file" accept="image/png,image/jpeg" />
      <button id="uploadBtn">Yükle</button>
      <span class="tiny" id="uploadMsg"></span>
    </div>

    <div id="gallery" class="grid"></div>
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-storage-compat.js"></script>

  <script>
    // --- Firebase config (senin projen) ---
    const firebaseConfig = {
      apiKey: "AIzaSyCBL7S0goBeWDRU1ac3oAY9KZ40bcOYtO0",
      authDomain: "sentient-artist-challenge.firebaseapp.com",
      projectId: "sentient-artist-challenge",
      storageBucket: "sentient-artist-challenge.firebasestorage.app",
      messagingSenderId: "529201434995",
      appId: "1:529201434995:web:f9eef65c6a00bd532a3506"
    };

    // --- Init ---
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    let currentRound = '';
    let votingOpen = false;
    let votingEndsAt = 0; // ms epoch

    const roundLabel  = document.getElementById('roundLabel');
    const countdownEl = document.getElementById('countdown');
    const galleryEl   = document.getElementById('gallery');

    const usernameEl  = document.getElementById('username');
    const fileEl      = document.getElementById('file');
    const uploadBtn   = document.getElementById('uploadBtn');
    const uploadMsg   = document.getElementById('uploadMsg');

    // -----------------------
    // settings/config oku
    // -----------------------
    async function loadConfig() {
      const snap = await db.collection('settings').doc('config').get();
      if (!snap.exists) {
        roundLabel.textContent = 'Tanımlı değil';
        return;
      }
      const cfg = snap.data() || {};
      currentRound = cfg.roundId || '';
      votingOpen   = !!cfg.votingOpen;

      // votingEndsAt: Firestore Timestamp veya sayı (ms)
      if (cfg.votingEndsAt?.toMillis) {
        votingEndsAt = cfg.votingEndsAt.toMillis();
      } else if (typeof cfg.votingEndsAt === 'number') {
        votingEndsAt = cfg.votingEndsAt;
      } else {
        votingEndsAt = 0;
      }

      roundLabel.textContent = currentRound || '—';
      startCountdown();
    }

    // -----------------------
    // Sayaç
    // -----------------------
    let timerId;
    function startCountdown() {
      clearInterval(timerId);
      function tick(){
        if (!votingOpen || !votingEndsAt) {
          countdownEl.textContent = 'Oylama kapalı';
          return;
        }
        const diff = votingEndsAt - Date.now();
        if (diff <= 0) {
          countdownEl.textContent = 'Süre bitti';
          return;
        }
        const sec = Math.floor(diff/1000)%60;
        const min = Math.floor(diff/1000/60)%60;
        const hrs = Math.floor(diff/1000/60/60)%24;
        const day = Math.floor(diff/1000/60/60/24);
        countdownEl.textContent = `${day}sa ${min + hrs*60}dk ${sec}sn`;
      }
      tick();
      timerId = setInterval(tick,1000);
    }

    // -----------------------
    // Galeri yükle
    // -----------------------
    async function loadGallery() {
      galleryEl.innerHTML = '';
      if (!currentRound) return;

      // round eşitliği + votes desc (composite index gerekli)
      const qSnap = await db.collection('drawings')
        .where('round','==',currentRound)
        .orderBy('votes','desc')
        .get();

      if (qSnap.empty) {
        galleryEl.innerHTML = '<div class="tiny" style="grid-column:1/-1;text-align:center">Galeri boş.</div>';
        return;
      }

      const alreadyVoted = localStorage.getItem('sac_voted_' + currentRound) === '1';

      qSnap.forEach(doc => {
        const d = doc.data();
        const card = document.createElement('div');
        card.className = 'card';

        const imgBox = document.createElement('div');
        imgBox.className = 'imgbox';

        // Görsele tıklayınca orijinali aç
        const a = document.createElement('a');
        a.href = d.imageUrl;
        a.target = "_blank";
        const img = document.createElement('img');
        img.src = d.imageUrl;
        a.appendChild(img);
        imgBox.appendChild(a);

        const c = document.createElement('div');
        c.className = 'content';

        const h = document.createElement('div');
        h.className = 'user';
        h.textContent = d.username || '—';

        const row = document.createElement('div');
        row.className = 'row';

        const votes = document.createElement('div');
        votes.className = 'chip';
        votes.textContent = 'Oy: ' + (d.votes ?? 0);

        const btn = document.createElement('button');
        btn.className = 'voteBtn';
        btn.textContent = 'Oy Ver';
        btn.disabled = alreadyVoted || !votingOpen;

        btn.addEventListener('click', async () => {
          if (!votingOpen) {
            alert('Oylama şu anda kapalı.');
            return;
          }
          // Tek oy: bu turun anahtarıyla kontrol
          const key = 'sac_voted_' + currentRound;
          if (localStorage.getItem(key) === '1') {
            alert('Bu turda zaten oy kullandın.');
            return;
          }

          try {
            // Güvenli oy artışı: Firestore transaction
            await firebase.firestore().runTransaction(async (trx) => {
              const ref = db.collection('drawings').doc(doc.id);
              const snap = await trx.get(ref);
              if (!snap.exists) throw new Error('Belge yok');
              const cur = snap.data();
              const newVotes = (cur.votes || 0) + 1;
              trx.update(ref, {
                votes: newVotes,
                // kurallar gereği değişmeyen alanları aynı değerle yazıyoruz:
                username: cur.username,
                imageUrl: cur.imageUrl,
                round: cur.round
              });
            });

            localStorage.setItem(key, '1'); // tek oy
            btn.disabled = true;
            loadGallery(); // yeniden sırala
          } catch (e) {
            console.error(e);
            alert('Oy verirken bir sorun oluştu.');
          }
        });

        row.appendChild(votes);
        row.appendChild(btn);

        c.appendChild(h);
        c.appendChild(row);

        card.appendChild(imgBox);
        card.appendChild(c);

        galleryEl.appendChild(card);
      });
    }

    // -----------------------
    // Dosya yükleme (tek görsel/hafta)
    // -----------------------
    uploadBtn.addEventListener('click', async () => {
      uploadMsg.textContent = '';
      const username = (usernameEl.value || '').trim();
      const file = fileEl.files?.[0];

      if (!username) { uploadMsg.textContent = 'Kullanıcı adı gerekli'; uploadMsg.className='tiny err'; return; }
      if (!file)     { uploadMsg.textContent = 'Bir görsel seçiniz';   uploadMsg.className='tiny err'; return; }
      if (!currentRound){ uploadMsg.textContent='Geçerli hafta ayarlı değil'; uploadMsg.className='tiny err'; return; }

      // Aynı kullanıcı o turda 1 görsel sınırı (client tarafı kontrol)
      try {
        const existSnap = await db.collection('drawings')
          .where('round','==',currentRound)
          .where('username','==',username)
          .limit(1)
          .get();
        if (!existSnap.empty) {
          uploadMsg.textContent = 'Bu hafta zaten bir görsel yüklediniz.';
          uploadMsg.className='tiny err';
          return;
        }
      } catch(e){ console.error(e); }

      // Storage’a yükle
      try {
        uploadBtn.disabled = true;

        const ext = file.type === 'image/png' ? 'png' : 'jpg';
        const safeUser = username.replace(/[^a-zA-Z0-9_-]/g,'_').slice(0,32);
        const path = `${currentRound}/${safeUser}_${Date.now()}.${ext}`;
        const ref = storage.ref().child(path);

        const meta = { contentType: file.type };
        await ref.put(file, meta);
        const url = await ref.getDownloadURL();

        // Firestore’a belge
        await db.collection('drawings').add({
          username: username,
          imageUrl: url,
          round: currentRound,
          votes: 0
        });

        uploadMsg.textContent = 'Yüklendi ✅';
        uploadMsg.className = 'tiny ok';
        fileEl.value = '';
        loadGallery();
      } catch (e) {
        console.error(e);
        uploadMsg.textContent = 'Yükleme başarısız';
        uploadMsg.className='tiny err';
      } finally {
        uploadBtn.disabled = false;
      }
    });

    // -----------------------
    // Başlat
    // -----------------------
    (async function init(){
      await loadConfig();
      await loadGallery();

      // config değişirse sayfayı senkron tutalım
      db.collection('settings').doc('config').onSnapshot(snap => {
        if (snap.exists) {
          const oldRound   = currentRound;
          const oldOpen    = votingOpen;
          const oldEnds    = votingEndsAt;
          const d = snap.data() || {};
          currentRound = d.roundId || '';
          votingOpen   = !!d.votingOpen;
          votingEndsAt = d.votingEndsAt?.toMillis ? d.votingEndsAt.toMillis() : (d.votingEndsAt || 0);
          roundLabel.textContent = currentRound || '—';
          startCountdown();

          // tur değiştiyse yeniden yükle
          if (currentRound !== oldRound || votingOpen !== oldOpen || votingEndsAt !== oldEnds) {
            loadGallery();
          }
        }
      });
    })();
  </script>
</body>
</html>

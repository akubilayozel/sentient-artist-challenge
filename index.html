<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sentient Artist Challenge</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0b0f; --card:#14141b; --muted:#9aa3b2; --text:#e5e7eb;
    --primary:#4f46e5; --primary-2:#6366f1; --accent:#22c55e; --danger:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:1180px;margin:28px auto 64px;padding:0 16px}
  h1{font-size:36px;margin:0 0 8px;text-align:center;font-weight:800}
  .sub{opacity:.8;text-align:center;margin-bottom:10px}
  .timer{font-weight:700;text-align:center;margin:0 0 22px}
  .row{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-bottom:18px}
  input[type="text"]{background:#0f1117;border:1px solid #1f2533;color:var(--text);border-radius:10px;padding:11px 12px;outline:none;width:270px}
  input[type="file"]{color:var(--muted)}
  button{background:var(--primary);border:0;color:#fff;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
  button:hover{background:var(--primary-2)}
  .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:16px}
  @media(max-width:980px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
  @media(max-width:640px){.grid{grid-template-columns:1fr}}

  .card{background:var(--card);border:1px solid #1f2533;border-radius:16px;overflow:hidden;display:flex;flex-direction:column}
  .imgbox{position:relative;background:#0f1117;aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;cursor:pointer}
  .imgbox img{max-width:100%;max-height:100%;object-fit:cover;width:100%;height:100%}
  .meta{padding:12px 14px;border-top:1px solid #1f2533}
  .user{font-weight:700;margin:0 0 8px}
  .flex{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .pill{background:#10131a;border:1px solid #1f2533;border-radius:999px;padding:6px 10px;font-size:13px;color:var(--muted)}
  .vote{padding:9px 14px}
  .muted{color:var(--muted)}
  .ok{color:var(--accent);font-weight:700}
  .warn{color:var(--danger);font-weight:700}

  /* Admin – voters table */
  .admin-bar{display:none;margin:14px auto 18px;max-width:1180px;padding:12px;border:1px dashed #2a3345;border-radius:12px}
  .admin-bar.visible{display:block}
  .table{background:var(--card);border:1px solid #1f2533;border-radius:14px;overflow:hidden}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-top:1px solid #1f2533;text-align:left;font-size:14px;vertical-align:top}
  th{background:#0f1117;font-weight:700}
  .badge{display:inline-block;background:#0f1117;border:1px solid #1f2533;border-radius:8px;padding:4px 8px;margin:2px;font-size:12px}

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;padding:24px;z-index:50}
  .modal.open{display:flex}
  .modal-inner{max-width:90vw;max-height:85vh}
  .modal-inner img{max-width:100%;max-height:85vh;display:block;border-radius:12px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Sentient Artist Challenge</h1>
    <div class="sub">Hafta: <span id="roundLabel">–</span></div>
    <div class="timer">Kalan süre: <span id="countdown">–</span></div>

    <div class="row">
      <input id="username" type="text" placeholder="Kullanıcı adınız" />
      <input id="file" type="file" accept="image/png, image/jpeg" />
      <button id="uploadBtn">Yükle</button>
    </div>

    <!-- Admin panel (sadece doğru key ile liste görünür) -->
    <div class="row" style="justify-content:center">
      <input id="adminKeyInput" type="text" placeholder="Admin Key" style="width:220px">
      <button id="showVotersBtn">Oy Verenleri Göster</button>
    </div>
    <div class="admin-bar" id="adminPanel">
      <div class="table">
        <table id="votersTable">
          <thead>
            <tr>
              <th>Görsel Sahibi</th>
              <th>Oy Sayısı</th>
              <th>Oy Verenler (kullanıcı adları)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="grid" id="grid"></div>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="modal-inner">
      <img id="modalImg" src="" alt="">
    </div>
  </div>

  <!-- Firebase v10 CDN -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, doc, getDoc, getDocs, query, where, orderBy,
      updateDoc, setDoc, addDoc, serverTimestamp, increment, arrayUnion, runTransaction
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getStorage, ref as sRef, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    /* >>>>>> BURAYA kendi Firebase Config'ini koy (seninkini zaten paylaştın) <<<<<< */
    const firebaseConfig = {
      apiKey: "AIzaSyCBL7S0goBeWDRU1ac3oAY9KZ40bcOYtO0",
      authDomain: "sentient-artist-challenge.firebaseapp.com",
      projectId: "sentient-artist-challenge",
      storageBucket: "sentient-artist-challenge.firebasestorage.app",
      messagingSenderId: "529201434995",
      appId: "1:529201434995:web:f9eef65c6a00bd532a3506"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const stg = getStorage(app);

    const els = {
      roundLabel: document.getElementById('roundLabel'),
      countdown:  document.getElementById('countdown'),
      username:   document.getElementById('username'),
      file:       document.getElementById('file'),
      uploadBtn:  document.getElementById('uploadBtn'),
      grid:       document.getElementById('grid'),
      modal:      document.getElementById('modal'),
      modalImg:   document.getElementById('modalImg'),
      adminKeyInput: document.getElementById('adminKeyInput'),
      showVotersBtn: document.getElementById('showVotersBtn'),
      adminPanel:   document.getElementById('adminPanel'),
      votersTable:  document.querySelector('#votersTable tbody')
    };

    let CFG = { roundId: "", votingOpen: false, votingEndsAt: 0, adminKey: "" };
    let drawings = []; // {id, data}

    async function loadConfig(){
      const snap = await getDoc(doc(db,'settings','config'));
      if(snap.exists()){
        const d = snap.data();
        CFG.roundId      = d.roundId || "";
        CFG.votingOpen   = !!d.votingOpen;
        CFG.votingEndsAt = d.votingEndsAt || 0;
        CFG.adminKey     = d.adminKey || "";
        els.roundLabel.textContent = CFG.roundId || "—";
        startCountdown();
      } else {
        els.roundLabel.textContent = "—";
      }
    }

    function startCountdown(){
      const tick = () => {
        const now = Date.now();
        const ms  = Math.max(0, (CFG.votingEndsAt || 0) - now);
        const sec = Math.floor(ms/1000);
        const d = Math.floor(sec / 86400);
        const h = Math.floor((sec % 86400)/3600);
        const m = Math.floor((sec % 3600)/60);
        const s = sec % 60;
        if(ms<=0){ els.countdown.textContent="Bitti"; return; }
        els.countdown.textContent = `${d}g ${h}s ${m}dk ${s}sn`;
        requestAnimationFrame(tick);
      };
      tick();
    }

    async function loadDrawings(){
      els.grid.innerHTML = "Yükleniyor…";
      const qy = query(collection(db,'drawings'), where('round','==', CFG.roundId));
      const qs = await getDocs(qy);
      drawings = [];
      qs.forEach(d=>drawings.push({id:d.id, ...d.data()}));
      // Çok oy alandan az olana sırala
      drawings.sort((a,b)=>(b.votes||0) - (a.votes||0));
      renderGrid();
    }

    function renderGrid(){
      els.grid.innerHTML = "";
      drawings.forEach(d=>{
        const card = document.createElement('div');
        card.className = 'card';
        const imgbox = document.createElement('div');
        imgbox.className = 'imgbox';
        const img = document.createElement('img');
        img.src = d.imageUrl;
        img.alt = d.username;
        img.addEventListener('click', ()=>{
          els.modalImg.src = d.imageUrl; els.modal.classList.add('open');
        });
        imgbox.appendChild(img);
        const meta = document.createElement('div');
        meta.className = 'meta';
        const u = document.createElement('div');
        u.className='user';
        u.textContent = d.username || "—";
        const fx = document.createElement('div');
        fx.className = 'flex';
        const votes = document.createElement('div');
        votes.className='pill';
        votes.textContent = `Oy: ${d.votes||0}`;
        const btn = document.createElement('button');
        btn.className='vote';
        btn.textContent='Oy Ver';
        btn.addEventListener('click', ()=>vote(d));
        fx.appendChild(votes); fx.appendChild(btn);
        meta.appendChild(u); meta.appendChild(fx);
        card.appendChild(imgbox); card.appendChild(meta);
        els.grid.appendChild(card);
      });
    }

    // Kullanıcının bu turda başka görsele oy verip vermediğini yerel listeden kontrol et
    function userVotedSomewhere(username){
      for(const d of drawings){
        if(Array.isArray(d.votedUsers) && d.votedUsers.includes(username)) return true;
      }
      return false;
    }

    async function vote(drw){
      const username = (els.username.value || "").trim();
      if(!username){ alert("Kullanıcı adı gerekli."); return; }
      if(!CFG.votingOpen){ alert("Oylama kapalı."); return; }
      if(userVotedSomewhere(username)){ alert("Bu turda zaten oy verdiniz."); return; }

      const drRef = doc(db,'drawings',drw.id);

      // İşlem: votedUsers arrayUnion + votes increment ve yarışmanın round'ı eşleşiyor mu kontrolü
      await runTransaction(db, async (tx)=>{
        const snap = await tx.get(drRef);
        if(!snap.exists()) throw new Error("Belge yok.");
        const data = snap.data();
        if(data.round !== CFG.roundId) throw new Error("Yanlış tur.");
        const list = Array.isArray(data.votedUsers) ? data.votedUsers : [];
        if(list.includes(username)) throw new Error("Bu görsele zaten oy verdiniz.");
        // Ayrıca diğer görsellere oy verdimi? – ek kontrol (hafif): çizimlerde arama
        if(userVotedSomewhere(username)) throw new Error("Bu turda zaten oy verdiniz.");
        tx.update(drRef,{
          votedUsers: arrayUnion(username),
          votes: increment(1)
        });
      });

      // Yerel görünümü tazele
      await loadDrawings();
    }

    // Yükleme (kullanıcı başına tek görsel – aynı kullanıcıya ait belge varsa engeller)
    async function upload(){
      const username = (els.username.value || "").trim();
      if(!username){ alert("Kullanıcı adı gerekli."); return; }
      if(!CFG.votingOpen){ alert("Oylama kapalı (yükleme için yarışma açık olmalı)."); return; }
      const file = els.file.files[0];
      if(!file){ alert("Lütfen bir görsel seçin (JPEG/PNG)."); return; }

      // Aynı kullanıcı bu turda görsel yüklemiş mi?
      const existQ = query(collection(db,'drawings'),
        where('round','==',CFG.roundId),
        where('username','==',username)
      );
      const exist = await getDocs(existQ);
      if(!exist.empty){ alert("Bu tur için zaten görsel yüklediniz."); return; }

      // Storage'a yükle
      const ext = file.name.split('.').pop().toLowerCase();
      const safeName = `${CFG.roundId}_${username}.${ext}`.replace(/\s+/g,'_');
      const rf = sRef(stg, `${CFG.roundId}/${safeName}`);
      await uploadBytes(rf,file);
      const url = await getDownloadURL(rf);

      await addDoc(collection(db,'drawings'),{
        username, imageUrl: url, round: CFG.roundId,
        votes: 0, votedUsers: [], createdAt: serverTimestamp()
      });
      els.file.value = "";
      await loadDrawings();
      alert("Yüklendi!");
    }

    // Admin – Oy verenler tablosu
    function fillVotersTable(){
      els.votersTable.innerHTML = "";
      drawings.forEach(d=>{
        const tr = document.createElement('tr');
        const td1 = document.createElement('td'); td1.textContent = d.username || "—";
        const td2 = document.createElement('td'); td2.textContent = d.votes || 0;
        const td3 = document.createElement('td');
        const list = Array.isArray(d.votedUsers) ? d.votedUsers : [];
        if(list.length===0){
          td3.innerHTML = `<span class="muted">Henüz oy veren yok</span>`;
        } else {
          td3.append(...list.map(u=>{
            const b = document.createElement('span'); b.className='badge'; b.textContent=u; return b;
          }));
        }
        tr.append(td1,td2,td3);
        els.votersTable.appendChild(tr);
      });
    }

    els.showVotersBtn.addEventListener('click', ()=>{
      const key = (els.adminKeyInput.value||"").trim();
      if(!key){ alert("Admin key girin."); return; }
      if(key !== CFG.adminKey){ alert("Yetkisiz anahtar."); return; }
      // doğruysa paneli göster ve tabloyu doldur
      els.adminPanel.classList.add('visible');
      fillVotersTable();
    });

    // Modal kapatma
    els.modal.addEventListener('click', (e)=>{
      if(e.target===els.modal || e.target===els.modalImg.parentElement){ els.modal.classList.remove('open'); }
    });

    els.uploadBtn.addEventListener('click', upload);

    // Başlat
    (async ()=>{
      await loadConfig();
      await loadDrawings();
    })();
  </script>
</body>
</html>
